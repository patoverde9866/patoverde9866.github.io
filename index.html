<!DOCTYPE html>
<html>
  <head>
    <title>Supabase Upload</title>
  </head>
  <body>
    <h2>Upload File to Supabase</h2>
    <input type="file" id="fileInput" />
    <button onclick="uploadFile()">Upload</button>
    <p id="status"></p>

    <script>
      const SUPABASE_URL = 'https://nvhszxgwiikhcupgevgb.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52aHN6eGd3aWlraGN1cGdldmdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ5MTkzMDEsImV4cCI6MjA2MDQ5NTMwMX0.potwT9luhWxmWnmDMNWQ74NjMJboaOWAOfo8_Zz1Gb4';
      const BUCKET = 'uploads';

      async function uploadFile() {
        const status = document.getElementById('status');
        const file = document.getElementById('fileInput').files[0];
        if (!file) return alert('Select a file first');

        const { data, error } = await fetch(`${SUPABASE_URL}/storage/v1/object/${BUCKET}/${file.name}`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': file.type,
            'x-upsert': 'true'
          },
          body: file
        }).then(res => res.json()).catch(err => ({ error: err }));

        if (error) {
          status.textContent = 'Upload failed';
          console.error(error);
        } else {
          status.textContent = 'Upload successful';
          notifyEdgeFunction(file.name);
        }
      }

      async function notifyEdgeFunction(filename) {
        const res = await fetch('https://nvhszxgwiikhcupgevgb.supabase.co/functions/v1/notify-upload', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ filename })
        });
        console.log(await res.text());
      }
    </script>
  </body>
</html>
